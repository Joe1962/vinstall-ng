' Gambas class file
'    This file is part of vinstall-ng

'    vinstall-ng is free software: you can redistribute it and/or modify
'    it under the terms of the GNU General Public License as published by
'    the Free Software Foundation, either version 2 of the License, or
'    (at your option) any later version.

'    vinstall-ng  is distributed in the hope that it will be useful,
'    but WITHOUT ANY WARRANTY; without even the implied warranty of
'    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
'    GNU General Public License for more details.

'    You should have received a copy of the GNU General Public License
'    along with vinstall-ng.  If not, see <http://www.gnu.org/licenses/>.



PUBLIC SUB Form_Open()
'DIM i AS Integer
  
  ME.tlbanner.Text = "<h2>" & tlbanner.Text & "</h2>"
  ME.tlInstallWarn.Text = ClsGlobal.sDistroName & Space(1) & ClsGlobal.sDistroVer & Space(1)&
  ("is being installed to your computer. Please wait.")
   
  ME.Refresh
  ME.create_installation_process_layout() 
WAIT 1
  
  ME.tmScroll.Enabled = TRUE
  '  ' perform partitioning as requested.
  '  ME.tlCurrPkg.Text = ("Preparing system partitions")
  '  IF MdlMain.PERFORM_PARTITIONING() > 0 THEN 
  '   Message.Error(("An error occurred while preparing partitions. Unable to continue"))
  '   RETURN 
  '   'RETURN 1
  '  ELSE 
  '   ' Update Status and continue to next step
  '     MdlMain.ADVANCE_INSTALL_PROGRESS(0)
  '  END IF 
  '  
  '  ' Count number of packages to be installed.
  ' MdlMain.COUNT_PACKAGES_TO_BE_INSTALLED()
  ' 
  '   i = MdlMain.INSTALL_PACKAGES(tlcurrpkg, pbinstall, ClsGlobal.iInstallMethod) 
  ' 
  ' IF i > 0 THEN 
  '   Message.Error(("Something went wrong during installation. Please try again"))
  ' ELSE 
  '   RETURN 
  ' END IF
  
  ' Embed the credits scroller
'  EXEC ["scroller/scroller.gambas", Embedder1.Id, "/mnt/source/CREDIT"]
SHELL "scroller/scroller.gambas " & Embedder1.Id
'ME.Embedder1.Raise()



END
PUBLIC FUNCTION GetNExt() AS String
  

  RETURN "Conf0"
  
END

PUBLIC SUB OnExit()
  
  
  
  
END
PUBLIC SUB StartUp()

  
  MdlMain.ADVANCE_STATUS_TREE("Step4", "Step5")

  
  
END




PUBLIC SUB create_installation_process_layout()
  
  DIM tl AS TextLabel
  DIM pb AS PictureBox
  DIM i AS Integer
  DIM sStages AS String[] = [("Prepare Partitions"), ("Install Base System (required)"), ("Install User-Selected Software")]
  
  MdlMain.ADVANCE_STATUS_TREE("Step4", "Step5")
  ClsGlobal.fRunningMainForm.Refresh()
    FOR i = 0 TO sStages.Max
      pb = NEW PictureBox(ME.svInstallProc)
        WITH pb
          .Expand = FALSE
          .Resize(28, 28)
          .Picture = Picture.Load("images/square.png")
          .Tag = i
          '.Stretch = TRUE
        END WITH 
        MdlMain.$objPboxes.Add(pb)
      tl = NEW TextLabel(ME.svInstallProc)
        WITH tl
          .Text = sStages[i]
          .Height = 28
          '.Width = .Parent.Width - (.X * 2)
          .Alignment = Align.TopLeft
          .Expand = TRUE
          .Visible = TRUE
        END WITH 
  NEXT 
  
  WAIT 1
  
  
  
  
END



PUBLIC SUB Form_Resize()

  ME.hbBottomPanel.Height = ME.ClientH - (ME.hbBottomPanel.top + 24)
  ME.svInstallProc.Width = svinstallproc.Parent.Width - (svinstallproc.left * 2)
  ME.svInstallProc.Height = svinstallproc.Parent.Height - (svinstallproc.top * 1.25)
  'ME.ScrlCredits.Move(4, 36, ScrlCredits.Parent.Width - (ScrlCredits.x * 2), ScrlCredits.Parent.Height - (ScrlCredits.Top * 1.5))
'  ME.wsScroll.Move(4, 36, wsScroll.Parent.Width - (wsscroll.x * 2), wsscroll.Parent.Height - (wsscroll.top + 12))
  ME.Embedder1.Move(4, 36, Embedder1.Parent.Width - (Embedder1.x * 2), Embedder1.Parent.Height - (Embedder1.Top + 24))

END


' PUBLIC SUB tmScroll_Timer()
' 
'   'INC ScrollView1.ScrollY
'   'PRINT ScrollView1.scrolly & " |" & ScrollView1.ScrollH & " | " & ScrollView1.Height
'     'IF ScrollView1.ScrollY = ScrollView1.scrollh - ScrollView1.Height THEN ScrollView1.Scroll(0, 0)
'     INC ScrlCredits.ScrollY
'     IF ScrlCredits.ScrollY = ScrlCredits.ScrollH - ScrlCredits.Height THEN 
'       WAIT 2
'       ScrlCredits.Scroll(0, 0)
'     END IF
' 
' 
' END

PUBLIC SUB tmScroll_Timer()

DIM i AS Integer
tmScroll.Enabled = FALSE ' fist kill this so that the process doesn't run all over again
WAIT 5 ' wait 5 seconds.
DEBUG ("Starting installation process")
  ' perform partitioning as requested.

  
    i = MdlMain.INSTALL_PACKAGES(tlcurrpkg, pbInstall, ClsGlobal.iInstallMethod) 
  
  IF i > 0 THEN 
    Message.Error(("Something went wrong during installation. Please try again"))
  ELSE 
    RETURN 
  END IF
  

END


