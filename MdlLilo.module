' Gambas module file

'    This file is part of vinstall-ng

'    vinstall-ng is free software: you can redistribute it and/or modify
'    it under the terms of the GNU General Public License as published by
'    the Free Software Foundation, either version 2 of the License, or
'    (at your option) any later version.

'    vinstall-ng  is distributed in the hope that it will be useful,
'    but WITHOUT ANY WARRANTY; without even the implied warranty of
'    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
'    GNU General Public License for more details.

'    You should have received a copy of the GNU General Public License
'    along with vinstall-ng.  If not, see <http://www.gnu.org/licenses/>.

PUBLIC arrLinuxIncCheckboxes AS Object[]
PUBLIC arrLinuxInitrdBoxes AS Object[]
PUBLIC arrLinuxNametxtboxes AS Object[]
PUBLIC arrLinuxAppendtxtBoxes AS Object[]
PUBLIC arrLinuxTextBoots AS Object[]
PUBLIC arrWinBootChecks AS Object[]
PUBLIC arrWinNameTxtBoxes AS Object[]
PUBLIC arrCbInitrds AS Object[]
PUBLIC arriDLabels AS Object[]
PRIVATE i AS Integer ' used for object key


PUBLIC FUNCTION TRIGGER_LILO_SETUP() AS Integer
  DIM IRET AS Integer
  
  MdlCore.WARN_STATUS("")
  ME.GENERATE_LILO_DOT_CONF ' Generates and write lilo.conf
  ME.COPY_KERNELS_AND_INITRDS ' copy kernels and initrs to the right place
  'Moved binding to FMain.class right after packages finish installing.
  'MdlConfLilo.PERFORM_BINDING() ' Performs binding mounts for LILO setup  
  IRET = MdlConfLilo.EXECUTE_LILO() ' Execute lilo in chroot mode
    RETURN IRET
  MdlCore.warn_status_off()
  
END

PUBLIC FUNCTION GENERATE_LILO_DOT_CONF_VIDEOMODES_SECTION() AS String
  
  DIM sInput AS String = Trim(FrmLiloSetup.cbVideoRes.Text)
  DIM sVGA AS String
  DIM sOutput AS String
    SELECT CASE sInput
      CASE (("Standard"))
        svga = "normal"
      CASE (("Bootsplash Med"))
        sVga = "788"
      CASE (("Bootsplash High"))
        sVga = "791"
      CASE (("Bootsplash Extra High"))
      sVga = "794"
    END SELECT 
    
sOutput = "# VESA framebuffer console @ 1024x768x64k \n" &
"vga = " & sVga & "\n" &
"# Normal VGA console \n" &
"#vga = normal \n" &
"#VESA framebuffer console @ 1024 x768x64k \n" &
"#vga = 791 \n" &
"#VESA framebuffer console @ 1024 x768x32k \n" &
"#vga = 790 \n" &
"#VESA framebuffer console @ 1024 x768x256 \n" &
"#vga = 773 \n" &
"#VESA framebuffer console @ 800 x600x64k \n" &
"#vga = 788 \n" &
"#VESA framebuffer console @ 800 x600x32k \n" &
"#vga = 787 \n" &
"#VESA framebuffer console @ 800 x600x256 \n" &
"#vga = 771 \n" &
"#VESA framebuffer console @ 640 x480x64k \n" &
"#vga = 785 \n" &
"#VESA framebuffer console @ 640 x480x32k \n" &
"#vga = 784 \n" &
"#VESA framebuffer console @ 640 x480x256 \n" &
"#vga = 769 \n" &
"# Begin listing OS Choices \n" 

RETURN sOutput
  
END



PUBLIC FUNCTION generate_lilo_dot_conf_header() AS String
    DIM sHeader AS String
    DIM sTarget, sVidMode, sDefOS AS String
    DIM iTimeOut AS Integer
    
    sTarget = Trim(FrmLiloSetup.cbLIloTarget.Text)
        IF InStr(sTarget, ("MBR of")) THEN 
          sTarget = Right(sTarget, Len(sTarget) - InStr(sTarget, "/") + 1)
        ELSE IF sTarget = ("Bootsector of ") & ClsPartSel.sRoot THEN 
          sTarget = ClsPartSel.sRoot
        ELSE IF sTarget = ("Floppy") THEN 
          sTarget = "/dev/df0"
        END IF
        
   'iTimeOut = FrmLiloSetup.cbTimeOutSec.value * 10
   iTimeOut = FrmLiloSetup.SpinBox1.Value * 10
   
   
    sHeader = "# LILO Configuration file \n" &
  "# Generated by the VectorLinux installer \n" &
  "# \n" &
  "# Begin lilo global configuration \n" &
  "# \n" &
  "boot = " & sTarget & "\n" &
  "default = " & Trim(FrmLiloSetup.cbBootDefault.Text) & "\n" &
  "prompt \n" &
  "compact \n" &
  "timeout = " & iTimeOut & "\n" &
  "# \n" &
  "# \n" &
  "# Override dangerous defaults that require the partition table: \n" &
  "change-rules \n" &
  "reset \n" 
  IF Exist(ClsGlobal.sTargetMnt &/ "boot" &/ "bitmap" &/ "boot.bmp") THEN 
    sHeader = sHeader & "\n" &
    "bitmap = /boot/bitmap/boot.bmp \n" 
  END IF
  'sHeader = sHeader & "\n" &
  

    
  RETURN sHeader
  
END




PUBLIC SUB GENERATE_LILO_DOT_CONF()
  
  DIM tb AS TextBox
  DIM cb, chbox AS CheckBox
  DIM sOsEntries AS String  
  DIM sSection, sClisection, sWinSection AS String
  DIM cbox AS ComboBox
  DIM sLabel, sKernel, sInitrd, sAppend, sTag AS String
  DIM sBootPath, sHeader, sFile, sVidModeSection AS String
  
  
  
  
      FOR EACH cb IN arrLinuxIncCheckboxes
          IF Right(cb.Tag, Len(cb.Tag) - InStr(cb.Tag, "/") + 1) = ClsPartSel.sRoot THEN 
            sBootPath = "/boot"
          ELSE 
            sBootPath = "/boot/tamu"
          END IF
        IF cb.Value = TRUE THEN 
          FOR EACH tb IN arrLinuxNametxtboxes
                IF tb.Tag = cb.Tag THEN 
                  sLabel = tb.Text
                  sKernel = "vmlinuz-" & Right(tb.Tag, Len(tb.Tag) - RInStr(tb.Tag, "/"))
                END IF
          NEXT 
          FOR EACH cbox IN arrCbInitrds
              IF cb.Tag = cbox.Tag THEN sInitrd = Trim(cbox.Text) & "-" & Right(cbox.Tag, Len(cbox.Tag) - RInStr(cbox.tag, "/"))
          NEXT 
          FOR EACH tb IN arrLinuxAppendtxtBoxes
            IF cb.Tag = tb.Tag THEN sAppend = Trim(tb.Text)
            
          NEXT 
          
          sSection = "image = " & sBootPath &/ sKernel & "\n" &
          "root = " & Right(cb.Tag, Len(cb.Tag) - InStr(cb.Tag, "/") + 1) & "\n" &
          "label = " & sLabel & "\n" &
          "append = \"" & sAppend & "\"" & "\n" &
          "initrd = " & sBootPath &/ sInitrd & "\n" &
          "read-only" & "\n"
              FOR EACH chbox IN ME.arrLinuxTextBoots
                IF chbox.Value = TRUE THEN 
                    IF chbox.tag = cb.Tag THEN
                        ' validate length of -tui entry
                        IF Len(sLabel) + Len("-tui") > 15 THEN 
                          Message.warning(("Your option to boot") & Space(1) & sLabel & Space(1) & ("is too long. it has been adjusted to \"Vector-cli\". You can run vasmCC after the first boot to modify your boot options"))
                          sLabel = "Vector"
                                                 
                        END IF
                    sClisection = "image = " & sBootPath &/ sKernel & "\n" &
          "root = " & Right(cb.Tag, Len(cb.Tag) - InStr(cb.Tag, "/") + 1) & "\n" &
          "label = " & sLabel & "-tui" & "\n" &
          "append = \"2 splash=verbose\"" & "\n" &
          "initrd = " & sBootPath &/ sInitrd & "\n" &
          "read-only" & "\n" 
                      ' sClisection = sSection
                      ' sClisection = Replace(sClisection, "append = " & sAppend, "append = \"2 splash=verbose\"")
                      ' sClisection = Replace(sClisection, "label = " & sLabel, "label = " & sLabel & "-cli") & "\n"
                    ELSE 
                      sClisection = ""
                    END IF
                
                END IF
              NEXT 
                  
          
          'Message(sSection)
          sOsEntries = sOsEntries & "\n" & sSection & "\n" & sClisection '& "\n" & sWinSection
          
          '  IF sClisection THEN Message(sClisection)
                'sSection = "image=" & "boot" &/ tb.Text
                'Message(sSection)
            END IF
          NEXT 
          
                       FOR EACH chbox IN ME.arrWinBootChecks
                      IF chbox.Value = TRUE THEN 
                        FOR EACH tb IN ME.arrWinNameTxtBoxes
                          IF tb.Tag = chbox.tag THEN 
                              sTag = Right(tb.Tag, Len(tb.Tag) - InStr(tb.Tag, "/") + 1)
                              
                            sWinSection = "other = " & sTag & "\n" & 'Right(tb.tag, Len(tb.Tag) - InStr(tb.Tag, "/")) & "<br>" &
                            "label = " & tb.Text & "\n" &
                            "table = " & Left(sTag, 8) & "\n"
                          ELSE 
                            sWinSection = ""
                          END IF
                            sOsEntries = sOsEntries & "\n" & sWinSection
                        
                      NEXT 
                  END IF
              NEXT 
        'END IF
      'NEXT   
      sHeader = ME.generate_lilo_dot_conf_header()
      sVidModeSection = ME.GENERATE_LILO_DOT_CONF_VIDEOMODES_SECTION()
      sFile = sHeader & "\n" & sVidModeSection & "\n \n" & sOsEntries
      
      'Message(sFile)
      
        ' move files to the right place
        ME.COPY_KERNELS_AND_INITRDS()
          IF Exist(ClsGlobal.sTargetMnt &/ "etc" &/ "lilo.conf") THEN 
            TRY MOVE ClsGlobal.sTargetMnt &/ "etc" &/ "lilo.conf" TO ClsGlobal.sTargetMnt &/ "etc" &/ "lilo.conf.dist"
          END IF
            
        File.Save(ClsGlobal.sTargetMnt &/ "etc" &/ "lilo.conf", sFile)
        
      ' write the file to the target
      
  
END



PUBLIC SUB COPY_KERNELS_AND_INITRDS()
  
    DIM tb AS TextBox
    DIM cbox AS ComboBox
    DIM cb AS CheckBox
    DIM sKernelPath, sPart, sShortpart AS String
    DIM sKernel, sInitrd, sKernelLoc AS String
    
    
    ' PREPARE HOST PARTITION
      'EXEC ["mount", "/dev/sdb8", "/mnt/target"] WAIT 
      EXEC ["mount", ClsPartSel.sRoot, "/mnt/target"] WAIT 
      'ClsGlobal.sTargetMnt = "/mnt/target"
      
      'ClsPartSel.sRoot = "/dev/sdb8"
      'ClsPartSel.fRoot = "reiserfs"
      TRY MKDIR ClsGlobal.sTargetMnt &/ "boot"
      TRY MKDIR ClsGlobal.sTargetMnt &/ "boot" &/ "tamu"
      'TRY MKDIR ClsGlobal.sTargetMnt &/ "etc"
      

    FOR EACH cb IN MdlLilo.arrLinuxIncCheckboxes
      IF cb.Value = TRUE THEN 
        sPart = Right(cb.Tag, Len(cb.Tag) - InStr(cb.Tag, "/") + 1)
        sShortpart = Right(sPart, Len(sPart) - RInStr(sPart, "/"))
       
        IF sPart = ClsPartSel.sRoot THEN 
            sKernelPath = "boot"
          ELSE 
            sKernelPath = "boot/tamu"
        END IF
        
        ' get the initrd name  
      FOR EACH cbox IN MdlLilo.arrCbInitrds
      'Message(cbox.tag)
        IF cbox.tag = cb.tag THEN 
        'Message("Found initrd")
          sInitrd = Trim(cbox.text)
          'IF sInitrd = "" THEN sInitrd = "initrd"
        END IF
      NEXT 
      'for each tb in MdlLilo.arr
          
              EXEC ["sync"] WAIT 
              EXEC ["mount", sPart, "/tmp/lilo_tmp"] WAIT 
                  IF MdlLiloOsList.ID_DISTRO("/tmp/lilo_tmp") LIKE "vector" THEN 
                      sKernelLoc = "/tmp/lilo_tmp/boot"
                  ELSE 
                      sKernelLoc = "/tmp/lilo_tmp"
                  END IF
                    
                    '  EXEC ["mkdir", "-p", ClsGlobal.sTargetMnt &/ "boot/tamu"] WAIT 
                      EXEC ["cp", sKernelLoc &/ sInitrd, ClsGlobal.sTargetMnt &/ sKernelPath &/ sInitrd & "-" & sShortpart] WAIT 
                      EXEC ["cp", sKernelLoc &/ "vmlinuz", ClsGlobal.sTargetMnt &/ sKernelPath &/ "vmlinuz-" & sShortpart] WAIT 
                      
              
              EXEC ["sync"] WAIT 
              EXEC ["umount", "/tmp/lilo_tmp"] WAIT   
   '   END IF
    'NEXT 
  'END IF
  
END IF
NEXT 
'EXEC ["umount", "/mnt/target"] WAIT 
END




PUBLIC SUB LIST_LINUX_OS()
  
  DIM sDump, sLinuxPart, sPart, vmlinuz, kernel AS String
  DIM sOsDesc, sInitrd, sKernelLoc AS String
  DIM x, y, i, ii AS Integer
  DIM sPartitions, sOs AS String[]
  
  arrLinuxIncCheckboxes = NEW Object[]
  arrLinuxInitrdBoxes = NEW Object[]
  arrLinuxNametxtboxes = NEW Object[]
  arrLinuxAppendtxtBoxes = NEW Object[]
  arrLinuxTextBoots = NEW Object[]
  arrCbInitrds = NEW Object[]
  arriDLabels = NEW Object[]
  
  
  
  SHELL "fdisk -l |grep -E \'83 *Linux\' | cut -f 1 -d \' \'" TO sDump
  sDump = Trim(sDump)
  sPartitions = Split(sDump, gb.NewLine)
      TRY MKDIR "/tmp/lilo_tmp"
          FOR i = 0 TO sPartitions.Count - 1
            sLinuxPart = Trim(sPartitions[i])
            sPart = Right(sLinuxpart, Len(sLinuxPart) - RInStr(sLinuxPart, "/"))
              EXEC ["mount", "/dev/" & sPart, "/tmp/lilo_tmp"] WAIT 
                      
                               IF IsDir("/tmp/lilo_tmp/boot") THEN   
                                  IF sPart = ClsPartSel.sRoot THEN 
                                    sOsDesc = "VectorLinux"                                
                                  ELSE 
                                  'FOR EACH vmlinuz IN Dir("/tmp/lilo_tmp/boot", "vmlinuz*", gb.File)
                                  sOsDesc = MdlLiloOsList.ID_DISTRO("/tmp/lilo_tmp")
                                  END IF
                                  'Message(sOsDesc)
                                      IF sOsDesc LIKE "vector" THEN 
                                        sKernelLoc = "/tmp/lilo_tmp/boot"
                                      ELSE 
                                        sKernelLoc = "/tmp/lilo_tmp"
                                      END IF
                                  FOR EACH vmlinuz IN Dir(sKernelLoc, "vmlinuz")
                                      'IF Stat("/tmp/lilo_tmp/boot" &/ vmlinuz).Type <> 6
                                        'sOsDesc = MdlLiloOsList.ID_DISTRO("/tmp/lilo_tmp")
                                        'sOsDesc = Replace(vmlinuz, "vmlinuz", sOsDesc)
                                        
                                      'Message(Stat("/tmp/lilo_tmp" &/ vmlinuz).Type)
                                       WITH FrmLiloSetup
                                        .tsLIloTabs.Index = .tsLIloTabs.Count - 1
                                        .tsLIloTabs.Text = sOsDesc & "-" & sPart 
                                        .tsLIloTabs.Count = .tsLIloTabs.Count + 1
                                              ' populate the tabstrip here
                                              ME.FILL_IN_LINUX_TAB(sOsDesc, "/dev" &/ sPart)
                                              
                                       END WITH 
                                       'END IF
                                  NEXT 
                          END IF
              
              EXEC ["umount", "/tmp/lilo_tmp"] WAIT 
        NEXT        
  
END

PUBLIC SUB LIST_WIN_INSTALLS()
  
  DIM sWinPartlist, sPartition AS String
  DIM sWinDrives AS String[]
  DIM i, ii AS Integer
  DIM sTmpMountPoint AS String = "/tmp/lilo_tmp"
  DIM hproc AS Process
  DIM sLook AS String
  ME.arrWinBootChecks = NEW Object[]
  ME.arrWinNameTxtBoxes = NEW Object[]
  
  SHELL "fdisk -l| grep -E \'^/dev/.* * .*(FAT16|FAT32|HPFS|NTFS|Win)\' | cut -f 1 -d \' \'" TO sWinPartlist
      sWinPartlist = Trim(sWinPartlist)
      sWinDrives = Split(sWinPartlist, gb.NewLine)
          FOR i = 0 TO sWinDrives.Count - 1
              sPartition = sWinDrives[i]
                    hproc = EXEC ["mount", sPartition, sTmpMountPoint] WAIT 
                          IF hproc.Value > 0 THEN 
                            EXEC ["sync"] WAIT 
                            EXEC ["umount", sPartition] WAIT 
                            EXEC ["mount", sPartition, sTmpMountPoint] WAIT 
                    END IF
                        'IF Exist(sTmpMountPoint &/ "*winnt*" &/ "*system32*" &/ "*winver.exe*") OR IF Exist(sTmpMountPoint &/ "*WINDOWS*" &/ "*system32*" &/ "*winver.exe*") OR IF IsDir(sTmpMountPoint &/ "*winnt*") THEN 
                        'IF Exist(sTmpMountPoint &/ "*[winnt]*" &/ "*[system32]*"
                            FOR EACH sLook IN Dir(sTmpMountPoint, "*", gb.Directory)
                              'IF Stat(sTmpMountPoint &/ sLook).Type = gb.Directory THEN 
                                'IF sLook LIKE "winnt" OR IF sLook LIKE "windows" THEN 
                                   IF UCase(sLook) LIKE "WINNT" OR IF UCase(sLook) LIKE "WINDOWS" THEN 
                                    'if Exist(sTmpMountPoint &/ sLook &/ 
                        IF Exist(sTmpMountPoint &/ sLook &/ "system32" &/ "winver.exe") OR Exist(sTmpMountPoint &/ sLook &/ "System32" &/ "winver.exe") OR Exist(sTmpMountPoint &/ sLook &/ "SYSTEM32" &/ "winver.exe") THEN
                        
'                        IF Exist(sTmpMountPoint &/ LIKE "winnt" &/ LIKE "system32" &/ LIKE "winver") THEN 
                        
                            'Message(sPartition & " has a windows install")
                            WITH FrmLiloSetup.tsLIloTabs
                              .Index = .Count - 1
                              .Text = "Windows" & Space(1) & "-" & Right(sPartition, Len(sPartition) - RInStr(sPartition, "/")) 
                              .Count = .Count + 1
                            END WITH 
                            ' populate the tab
                                ME.FILL_IN_WINDOWS_TAB("Windows", sPartition)
                            
                        END IF
                      
                        END IF
'                      END IF
                  NEXT 
                    
                    
                    EXEC ["sync"] WAIT 
                    EXEC ["umount", sTmpMountPoint] WAIT 
          NEXT 
  
END

PUBLIC SUB FILL_IN_WINDOWS_TAB(sDesc AS String, sHostPart AS String)
  
  DIM tb AS TextBox
  DIM tl AS TextLabel
  DIM cb AS CheckBox
  DIM hr AS Separator
  DIM x, y AS Integer
  
  x = 4
  y = 12
  
            tl = NEW TextLabel(FrmLiloSetup.tsLIloTabs)
                WITH tl
                    .Text = "<h3>" & sDesc & Space(1) & ("installed on") & Space(1) & sHostPart & "</h3>"
                    .Height = 21
                    .Width = MdlObjSizer.get_object_width(.Text)
                    .Move(x, y)
                END WITH 
                y = y + tl.Height + 4
            hr = NEW Separator(FrmLiloSetup.tsLIloTabs)
              WITH hr
                .Height = 2
                .Move(x - 2, y)
                .Width = FrmLiloSetup.tsLIloTabs.Width - x
              END WITH 
  y = y + 16
  
            cb = NEW CheckBox(FrmLiloSetup.tsLIloTabs) AS "bBootWinInstall"
                WITH cb
                    .Move(x, y)
                    .Value = TRUE
                    .Text = ("Include this installation in the boot menu")
                    .Width = MdlObjSizer.get_object_width(.Text) + 36
                    .Height = 21
                    .Tag = sHostPart
                END WITH 
                  ME.arrWinBootChecks.Add(cb)
                y = y + cb.Height + 4
            
            tl = NEW TextLabel(FrmLiloSetup.tsLIloTabs)
                WITH tl
                    .Text = ("Name")
                    .Height = 21
                    .Width = MdlObjSizer.get_object_width(.Text)
                    .Move(x, y)
                    .Alignment = Align.Normal
                END WITH 
            'y = y + tl.Height + 4
            
            tb = NEW TextBox(FrmLiloSetup.tsLIloTabs) AS "OsNameTxtBox" ' " txtWinNameBox ""
                WITH tb
                    .Height = 21
                    .Width = 200
                    .Text = sDesc & "-" & Right(sHostPart, Len(sHostPart) - RInStr(sHostPart, "/"))
                    .MaxLength = 15
                    .Move(x + tl.Width + 8, y)
                    .Tag = sHostPart
                END WITH 
                ME.arrWinNameTxtBoxes.Add(tb)
        
  
END









  PUBLIC SUB FILL_IN_LINUX_TAB(sDesc AS String, sHostPart AS String)
  
  DIM tb AS TextBox
  DIM cb AS CheckBox
  DIM tl AS TextLabel
  DIM x, y AS Integer
  DIM hrsep AS Separator
  DIM cbox AS ComboBox
  DIM sDump AS String
  DIM sInitrdLoc AS String
  'DIM i AS Integer
  'DIM sKernelStr AS String
  IF sDesc LIKE "vector" THEN 
      sInitrdLoc = "/tmp/lilo_tmp/boot" 
  ELSE 
      sInitrdLoc = "/tmp/lilo_tmp"
  END IF
  'Message(sInitrdLoc)
  

  INC i
  x = 4
  y = 12
      'WITH FrmLiloSetup.tsLIloTabs
      tl = NEW TextLabel(FrmLiloSetup.tsLIloTabs) AS "osItroLabels"
        WITH tl
         .Move(x, y)
          .Text = "<h3>" & sDesc & Space(1) & "Linux" & Space(1) & ("installed in") & Space(1) & sHostPart & "</h3>"
          .Height = 21
          .Width = MdlObjSizer.get_object_width(.Text) + 36
          .Alignment = Align.Normal
          .tag = i & sHostPart
        END WITH 
          arriDLabels.Add(tl)
  y = y + tl.Height + 4
  
    hrsep = NEW Separator(FrmLiloSetup.tsLIloTabs) AS "Separators"
      WITH hrsep
        .Height = 2
        .Move(x - 2, y, FrmLiloSetup.tsLIloTabs.Width - 4)
      END WITH 
      y = y + 16
  
  
      
      cb = NEW CheckBox(FrmLiloSetup.tsLIloTabs) AS "cbIncCheckboxes"
        WITH cb
          .Tag = i & sHostPart
          .Text = ("Include in boot menu")
          .Value = TRUE
          .Width = MdlObjSizer.get_object_width(.Text) + 36
          .Height = 21
          .Move(x, y)
        END WITH 
          ME.arrLinuxIncCheckboxes.Add(cb)
          y = y + cb.Height + 4
        
                                tl = NEW TextLabel(FrmLiloSetup.tsLIloTabs) AS "NameLabels"
                                    WITH tl
                                    .Move(x, y)
                                    .Text = ("Name")
                                    .Width = MdlObjSizer.get_object_width(.Text)
                                    .Height = 21
                                    .Alignment = Align.Normal
                                  END WITH 
                                  'y = y + tl.Height + 4
                                  
                                tb = NEW TextBox(FrmLiloSetup.tsLIloTabs) AS "OsNameTxtBox"
                                      WITH tb
                                              .Height = 21
                                              .Width = 200
                                              .MaxLength = 15
                                              .Move(x + tl.Width + 8, y)
                                                IF sHostPart = ClsPartSel.sRoot THEN 
                                                  .text = "VectorLinux"
                                                ELSE 
                                                  .Text = sDesc & "-" & Right(sHostPart, Len(sHostPart) - RInStr(sHostPart, "/"))
                                                END IF
                                              .Tag = i & sHostPart
                                      END WITH 
                                      ME.arrLinuxNametxtboxes.Add(tb)
                                      x = x + tl.Width + 8 + tb.Width
                                tl = NEW TextLabel(FrmLiloSetup.tsLIloTabs)
                                    WITH tl
                                        .Text = ("Initrd")
                                        .Height = 21
                                        .Width = MdlObjSizer.get_object_width(.Text)
                                        .Move(x + 8, y)
                                        .Alignment = Align.Bottom
                                    END WITH 
                                
                                cbox = NEW ComboBox(FrmLiloSetup.tsLIloTabs)
                                  WITH cbox
                                    .Move(x + tl.Width + 16, y)
                                    .ReadOnly = TRUE
                                    .Width = 200
                                    .Height = 21
                                    .Tag = i & sHostPart
                                            ' BROWSE FOR INITRD IMAGES
                                                FOR EACH sDump IN Dir(sInitrdLoc, "initrd*").Sort(gb.Ascent)
                                                    IF cbox.Find(Trim(sDump)) = -1 THEN cbox.Add(Trim(sDump))                                            
                                                NEXT 
                                         .Sorted = gb.Ascent
                                         '.Sorted = TRUE     
                                  END WITH 
                                        ME.arrCbInitrds.Add(cbox)
                              
                                      
                                      x = 4
                                      y = y + tb.Height + 4
                                      
                                      
                                tl = NEW TextLabel(FrmLiloSetup.tsLIloTabs) AS "AppendLabel"
                                    WITH tl
                                      .Text = ("Kernel boot options")
                                      .Width = MdlObjSizer.get_object_width(.Text)
                                      .Height = 21
                                      .Alignment = Align.Normal
                                      .Move(x, y)
                                    END WITH 
                                
                                tb = NEW TextBox(FrmLiloSetup.tsLIloTabs) AS "txtAppendBox"
                                    WITH tb
                                      .Move(x + tl.Width + 8, y, FrmLiloSetup.tsLIloTabs.Width - (x + tl.Width + 8 + 4), 21)
                                      .Text = ""
                                      .Tag = i & sHostPart
                                      .ReadOnly = FALSE
                                    END WITH 
                                    ME.arrLinuxAppendtxtBoxes.Add(tb)
                                y = y + tb.Height + 4
                                
          IF sHostPart = ClsPartSel.sRoot THEN 
              ' ADD A NEW CHECK BOX TO BOOT INTO TEXT MODE
              cb = NEW CheckBox(FrmLiloSetup.tsLIloTabs) AS "bDoTextMode"
                  WITH cb
                  .Move(x, y)
                  .Value = FALSE
                  .Text = ("Add option to boot this operating system into text mode")
                  .Height = 21
                  .Width = MdlObjSizer.get_object_width(.Text) + 36
                  .Tag = i & sHostPart
                  END WITH 
                    ME.arrLinuxTextBoots.Add(cb)
        END IF
        
  
END


PUBLIC SUB LIST_DEFAULT_BOOT_OPTIONS()
  
  DIM cb, cbox AS CheckBox
  DIM tb AS TextBox
  
        FOR EACH cb IN ME.arrLinuxIncCheckboxes
          IF cb.Value = TRUE THEN 
              FOR EACH tb IN ME.arrLinuxNametxtboxes
                IF tb.Tag = cb.Tag THEN 
                    WITH FrmLiloSetup.cbBootDefault
                      IF .Find(tb.Text) = -1 THEN .Add(tb.Text)
                    END WITH 
              END IF
          NEXT 
          FOR EACH cbox IN ME.arrLinuxTextBoots
            IF cb.Tag = cbox.Tag THEN 
              IF cbox.Value = TRUE THEN 
                  FOR EACH tb IN ME.arrLinuxNametxtboxes
                    IF cbox.Tag = tb.Tag THEN 
                        IF FrmLiloSetup.cbBootDefault.Find(tb.Text & "-tui") = -1 THEN FrmLiloSetup.cbBootDefault.Add(tb.Text & "-tui")
                    END IF
                  NEXT 
              END IF
            END IF
        NEXT 
    END IF
  NEXT 
  
  ' List windows installs now
  FOR EACH cb IN ME.arrWinBootChecks
      IF cb.Value = TRUE THEN 
        FOR EACH tb IN ME.arrWinNameTxtBoxes
          IF cb.Tag = tb.Tag THEN 
            IF FrmLiloSetup.cbBootDefault.Find(tb.Text) = -1 THEN FrmLiloSetup.cbBootDefault.Add(tb.Text)
          END IF
        NEXT 
      END IF
  NEXT 
  
END


PUBLIC SUB OsNameTxtBox_LostFocus()
  
  FrmLiloSetup.cbBootDefault.Clear()
  ME.LIST_DEFAULT_BOOT_OPTIONS()
  
END


' PUBLIC SUB OsNameTxtBox_KeyPress()
'   
'   DIM sOld AS String
'   DIM iKey AS Integer
'   'sOld = Left(LAST.Text, Len(LAST.text) - 1)
'   'iKey = FrmLiloSetup.cbBootDefault.Find(sOld)
'   
'   'IF iKey <> -1 THEN FrmLiloSetup.cbBootDefault.Remove(iKey)
'   'FrmLiloSetup.cbBootDefault.Clear()
'   'ME.LIST_DEFAULT_BOOT_OPTIONS
'   'FrmLiloSetup.tsLIloTabs.Text = LAST.text
'   'IF FrmLiloSetup.cbBootDefault.Find(sOld) <> -1 THEN FrmLiloSetup.cbBootDefault.Remove(FrmLiloSetup.cbBootDefault.Find(sOld))
'   'FrmLiloSetup.cbBootDefault.Add(LAST.text)
'   'Message(sOld)
'   
'   
' END

 PUBLIC SUB OsNameTxtBox_KeyRelease()
'   DIM iKey AS Integer
'   
'   iKey = FrmLiloSetup.cbBootDefault.Find(Left(LAST.Text, Len(LAST.text) - 1))
'   IF ikey <> -1 THEN FrmLiloSetup.cbBootDefault.Remove(iKey)
'   FrmLiloSetup.cbBootDefault.Add(LAST.text)
FrmLiloSetup.cbBootDefault.Clear()
ME.LIST_DEFAULT_BOOT_OPTIONS()
   FrmLiloSetup.tsLIloTabs.Text = LAST.text
'   'FrmLiloSetup.cbBootDefault.Add(LAST.text)
'   
'   
'   
 END
